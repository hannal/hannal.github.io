I"¼/<h3 id="ì›¹í˜ì´ì§€-ê¸ì–´ì˜¤ê¸°">ì›¹í˜ì´ì§€ ê¸ì–´ì˜¤ê¸°</h3>

<p>Pythonìœ¼ë¡œ ì›¹í˜ì´ì§€ ì—´ ê³³ì„ ê¸ì–´ì™€ì„œ í•˜ë‚˜ë¡œ í•©ì³ ë³´ê² ìŠµë‹ˆë‹¤. Python HTTP libraryì¸ <a href="http://docs.python-requests.org/en/latest/">requests</a>ë¥¼ ì“°ë©´ ì•„ì£¼ ê°„ë‹¨í•©ë‹ˆë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import requests

def fetch_page_by_url(url):
    res = requests.get(url)

    if int(res.status_code / 100) == 2:
        return res.text

merged_text = []
for i in range(0, 10):
    result = fetch_page_by_url(
        'http://localhost:8000/{}.html'.format(i)
    )

    if result is not None:
        merged_text.append(result)

do_something(merged_text.join(''))
</code></pre></div></div>

<h3 id="celeryë¥¼-ì´ìš©í•´-ë¹„ë™ê¸°-ë°©ì‹ìœ¼ë¡œ-ê¸ì–´ì˜¤ê¸°">Celeryë¥¼ ì´ìš©í•´ ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ê¸ì–´ì˜¤ê¸°</h3>

<p>ì°¨ë¡€ëŒ€ë¡œ ê¸ì–´ì˜¤ë‹ˆ ì—´ ê°œ í˜ì´ì§€ë¥¼ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸° ì „ê¹Œì§€ëŠ” ê²°ê³¼ë¥¼(<code class="highlighter-rouge">do_something(merged_text.join(''))</code>) í™•ì¸í•˜ì§€ ëª»í•©ë‹ˆë‹¤. <a href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing</a>ì„ ì´ìš©í•´ ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ë¡œ ë™ì‹œì„±ì„ í™•ë³´í•´ë„ ë˜ì§€ë§Œ, ë¶„ì‚° ì‘ì—… í ì‹œìŠ¤í…œì¸ <a href="http://celery.readthedocs.org/en/latest/">Celery</a>ë¡œ ì‰½ê³  ê°„í¸í•˜ê²Œ ë¹„ë™ê¸° ì²˜ë¦¬í•˜ê¸°ë„ í•©ë‹ˆë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from celery import Celery

app = Celery(__name__)

@app.task
def fetch_page_by_url(url):
    res = requests.get(url)

    if int(res.status_code / 100) == 2:
        return res.text

merged_text = []
for i in range(0, 10):
    result = fetch_page_by_url.apply_async(
        'http://localhost:8000/{}.html'.format(i)
    )

    if result is not None:
        merged_text.append(result)

do_something(merged_text.join(''))
</code></pre></div></div>

<p>ì´ ì½”ë“œì—ëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. Celery ì‘ì—… ìˆ˜í–‰ ê°ì²´ë¡œ ì¥ì‹ëœ(decorated) <code class="highlighter-rouge">fetch_page_by_url</code> ê°ì²´ì˜ <code class="highlighter-rouge">apply_async()</code> ë©”ì„œë“œë¥¼<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> ì´ìš©í•˜ì—¬ <strong>ë¹„ë™ê¸°</strong>ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ë°, ì´ ë©”ì„œë“œê°€ ë°˜í™˜í•˜ëŠ” ê°ì²´ëŠ” <code class="highlighter-rouge">res.text</code>ê°€ ì•„ë‹ˆë¼ Celery ê²°ê³¼ ì‘ì—…ì„ ë‹¤ë£¨ëŠ” ê°ì²´ì…ë‹ˆë‹¤. ê²Œë‹¤ê°€ ë¹„ë™ê¸°ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ë°”ë¡œ í”„ë¡œê·¸ë¨ ìˆ˜í–‰ ì œì–´ê¶Œì„ í˜¸ì¶œìì—ê²Œ ë°˜í™˜í•˜ë¯€ë¡œ <code class="highlighter-rouge">fetch_page_by_url.apply_async(...)</code> í˜¸ì¶œì´ ë˜ìë§ˆì ë°”ë¡œ ë‹¤ìŒ êµ¬ë¬¸ì„ ìˆ˜í–‰í•˜ëŠ”ë°, ì›¹ í˜ì´ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‘ì—…ì´ ëë‚¬ëŠ”ì§€ ì—¬ë¶€ëŠ” ì•Œì§€ ëª» í•©ë‹ˆë‹¤.</p>

<p>ì´ ë¬¸ì œë¥¼ í”¼í•˜ë ¤ë©´ <code class="highlighter-rouge">get()</code> ë©”ì„œë“œë¥¼ ì´ìš©í•©ë‹ˆë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    if result.get() is not None:
        merged_text.append(result)
</code></pre></div></div>

<p><code class="highlighter-rouge">get()</code> ë©”ì„œë“œëŠ” ë¹„ë™ê¸°ë¡œ ìˆ˜í–‰í•˜ëŠ” ì‘ì—… ê°ì²´(<code class="highlighter-rouge">fetch_page_by_url()</code>)ê°€ ì‘ì—…ì„ ë§ˆì¹˜ê³  ê°’ì„ ë°˜í™˜í•˜ê¸°ë¥¼ <strong>ë™ê¸°ì‹</strong>ìœ¼ë¡œ ê¸°ë‹¤ë ¤ì„œ ë°˜í™˜í•©ë‹ˆë‹¤. ì–´?! ì´ë ‡ê²Œ í•  ê±°ë¼ë©´ êµ³ì´ Celeryë¥¼ ì“¸ í•„ìš”ê°€ ì—†ì§€ìš”. Celeryì—ê²Œ ì—¬ëŸ¬ ì‘ì—…ì„ ë§¡ê²¨ì„œ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ê³ , ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•œ ê²°ê³¼ë¥¼ ë°›ì•„ë‹¤ ë­”ê°€ë¥¼ í•˜ë ¤ë©´ ë‹¤ë¥¸ ë°©ë²•ì„ ì¨ì•¼ í•©ë‹ˆë‹¤. ì´ ê¸€ì—ì„œëŠ” <code class="highlighter-rouge">chain</code>ì™€ <code class="highlighter-rouge">chord</code>ì„ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.</p>

<h3 id="chain-ê¸°ëŠ¥">chain ê¸°ëŠ¥</h3>

<p><code class="highlighter-rouge">chain</code> ê¸°ëŠ¥ì€ ì´ë¦„ì—ì„œ ì „í•´ì§€ë“¯ì´ ì‘ì—…ì„ ì²´ì¸ì²˜ëŸ¼ ì¤„ì¤„ì´ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from celery import chain

@app.task
def fetch_page_by_url(url, append_text=None):
    res = requests.get(url)

    if int(res.status_code / 100) == 2:
        if append_text is None
            return res.text
        else:
            res.text + append_text

tasks = []
for i in range(0, 10):
    tasks.append(
        fetch_page_by_url.subtask(
            'http://localhost:8000/{}.html'.format(i)
        )
    )

result = chain(tasks)()
</code></pre></div></div>

<p><code class="highlighter-rouge">subtask()</code>ëŠ” Celery ì‘ì—… ê°ì²´ë¥¼ í•˜ìœ„ ì‘ì—…ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>. <code class="highlighter-rouge">fetch_page_by_url</code> ê°ì²´ë¥¼ í•˜ìœ„ ì‘ì—…ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ì‘ì—… ì—´ ê°œë¥¼ ë‹´ì•„ <code class="highlighter-rouge">chain()</code>ì— ì „ë‹¬í•˜ë©´ <code class="highlighter-rouge">chain()</code>ì€ ìˆœì„œëŒ€ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ê° ì‘ì—…ì´ ë°˜í™˜í•˜ëŠ” ê°ì²´ëŠ” ë‹¤ìŒ ì‘ì—…ìì—ê²Œ ì¸ìë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. ì²« ë²ˆì§¸ <code class="highlighter-rouge">fetch_page_by_url()</code> í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ëŠ” ì›¹í˜ì´ì§€ ë¬¸ìì—´ì„ ë‘ ë²ˆì§¸ <code class="highlighter-rouge">fetch_page_by_url()</code>ëŠ” ë‘ ë²ˆì§¸ ì¸ìë¡œ ë°›ëŠ” ê²ƒì´ì£ . ê·¸ë˜ì„œ ë‘ ë²ˆì§¸ <code class="highlighter-rouge">fetch_page_by_url()</code>ë¶€í„°ëŠ” ì• ì‘ì—…ìê°€ ë°˜í™˜í•˜ëŠ” ê²°ê³¼ë¥¼ ë„˜ê²¨ ë°›ëŠ” ê²ƒì´ì§€ìš”.</p>

<p>ë‹¤ë¥¸ ì˜ˆë¥¼ ë“¤ì–´ ë³´ê² ìŠµë‹ˆë‹¤. ìˆ«ì ë‘ ê°œë¥¼ ì¸ìë¡œ ì „ë‹¬í•˜ë©´ ë‘ ìˆ«ìë¥¼ ë”í•˜ëŠ” ì‘ì—…ìë¥¼ ì“°ê² ìŠµë‹ˆë‹¤.</p>

<ol>
  <li>ì²« ë²ˆì§¸ ì…ˆì€ 1 + 1 ì…ë‹ˆë‹¤.</li>
  <li>ë‘ ë²ˆì§¸ ì…ˆì€ ì²« ë²ˆì§¸ ë§ì…ˆ ê²°ê³¼ë¥¼ ë°›ì•„ì„œ 10ì„ ë”í•©ë‹ˆë‹¤.</li>
  <li>ì„¸ ë²ˆì§¸ ì…ˆì€ ë‘ ë²ˆì§¸ ë§ì…ˆ ê²°ê³¼ë¥¼ ë°›ì•„ì„œ 100ì„ ë”í•©ë‹ˆë‹¤.</li>
</ol>

<p>ì´ê±¸ <code class="highlighter-rouge">chain()</code>ì„ ì´ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>do_chain_tasks = chain(add.s(1, 1), add.s(10), add.s(100))
do_chain_tasks()
</code></pre></div></div>

<p><code class="highlighter-rouge">chain()</code>ë„ ë°”ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼ Celery ì‘ì—… ê°ì²´ë¥¼ ë°˜í™˜í•˜ë©°<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>, ì´ ì‘ì—… ê°ì²´ë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ë°”ë¡œ ìœ„ ì½”ë“œëŠ” <code class="highlighter-rouge">chain(...)()</code>ë¼ëŠ” êµ¬ë¬¸ì„ ë‚˜ëˆˆ ê²ƒì…ë‹ˆë‹¤.</p>

<p>ì¬ë°ŒëŠ” ì ì€ CeleryëŠ” ë¹„íŠ¸ ì—°ì‚°ìœ¼ë¡œë„ <code class="highlighter-rouge">chain()</code> ì‘ì—… ê°ì²´ë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤ëŠ” ì ì…ë‹ˆë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(
    fetch_page_by_url.s('http://localhost:8000/0.html') |
    fetch_page_by_url.s('http://localhost:8000/1.html') |
    fetch_page_by_url.s('http://localhost:8000/2.html') |
    fetch_page_by_url.s('http://localhost:8000/3.html')
).apply_async()
</code></pre></div></div>

<p>ì°¸ ê¼¼ê¼¼í•˜ê²Œ ë§Œë“¤ì–´ ë†¨ì–´ìš”. :)</p>

<h3 id="chord-ê¸°ëŠ¥">chord ê¸°ëŠ¥</h3>

<p><code class="highlighter-rouge">chain()</code>ì„ ì´ìš©í•´ ë¹„ë™ê¸°ë¡œ ì—´ ê°œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ í•©ì³¤ëŠ”ë°, ì•„ì‰¬ìš´ ë§ˆìŒì´ ë“­ë‹ˆë‹¤. ì „ì²´ ì‘ì—… ìì²´ëŠ” ë¶„ëª… ë¹„ë™ê¸°ë¡œ ì‹œì‘í•œ ê²Œ ë§ì§€ë§Œ, ì›¹í˜ì´ì§€ë¥¼ ê¸ì–´ì˜¤ëŠ” ì‘ì—…ë„ ë™ì‹œì— ë¶„ì‚°í•´ì„œ ì²˜ë¦¬í•˜ë©´ ë” íš¨ìœ¨ì´ ì¢‹ì„ ê²ë‹ˆë‹¤. <code class="highlighter-rouge">chord()</code>ëŠ” í•˜ìœ„ ì‘ì—…ì„ ë™ì‹œì— ìˆ˜í–‰í•˜ê³ , ê° ì‘ì—…ìê°€ ë°˜í™˜í•˜ëŠ” ê°’ì„ callback ì‹¤í–‰ ê°ì²´ë¡œ ì „ë‹¬í•´ì¤ë‹ˆë‹¤.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from collections import MutableSequence
from celery import chord

@app.task
def fetch_page_by_url(url):
    res = requests.get(url)

    if int(res.status_code / 100) == 2:
        return res.text

@app.task
def merge_text(texts):
    assert(isinstance(texts, MutableSequence))
    return texts.join('')

tasks = []
for i in range(0, 10):
    tasks.append(
        fetch_page_by_url.s('http://localhost:8000/{}.html'.format(i))
    )

do_chain_tasks = chord(tasks)
do_chain_tasks(merge_text.s())
</code></pre></div></div>

<p><code class="highlighter-rouge">fetch_page_by_url()</code> í•¨ìˆ˜ê°€ ì›ë˜ëŒ€ë¡œ(?) ëŒì•„ì™”ê³ , <code class="highlighter-rouge">merge_text()</code> í•¨ìˆ˜ê°€ ìƒˆë¡œ ì¶”ê°€ëìŠµë‹ˆë‹¤. <code class="highlighter-rouge">merge_text()</code>ëŠ” ì „ë‹¬ë°›ì€ ì¸ì <code class="highlighter-rouge">texts</code>ë¥¼ í•©ì¹˜ëŠ” ì¼ì„ í•˜ëŠ”ë°, <code class="highlighter-rouge">fetch_page_by_url()</code>ê°€ ë°˜í™˜í•˜ëŠ” ë¬¸ìì—´ì„ ë‹´ì€ ë¦¬ìŠ¤íŠ¸í˜•(<code class="highlighter-rouge">list</code>) ê°ì²´ì…ë‹ˆë‹¤. ë§¨ ì²˜ìŒì— ë¹„ë™ê¸°ë¡œ ì‘ì„±í•œ ì½”ë“œì—ì„œ ì›¹í˜ì´ì§€ ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë‹´ì€ <code class="highlighter-rouge">merged_text</code>ì™€ ê°™ìŠµë‹ˆë‹¤.</p>

<p><code class="highlighter-rouge">chord()</code>ëŠ” ê° ì‘ì—…ì(<code class="highlighter-rouge">fetch_page_by_url()</code>)ê°€ ë°˜í™˜í•˜ëŠ” ê°’ì„ ë¦¬ìŠ¤íŠ¸í˜•ìœ¼ë¡œ ëª¨ì•„ì„œ callback ê°ì²´ì—ê²Œ ì¸ìë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. <code class="highlighter-rouge">chord()</code>ë¡œ ë§Œë“  Celery ì‘ì—… ê°ì²´ë¡œ callback ê°ì²´ë¥¼ ì „ë‹¬í•  ë•Œ ì¸ìë¥¼ ì§€ì •í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. ì•Œì•„ì„œ ë„£ì–´ ì¤ë‹ˆë‹¤.</p>

<p>ê·¼ë° ì´ ì½”ë“œì—” ì‚¬ì†Œí•˜ë‹¤ë©´ ì‚¬ì†Œí•˜ê³  ì‹¬ê°í•˜ë‹¤ë©´ ì‹¬ê°í•œ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì‘ì—…ë“¤ì„ ë¹„ë™ê¸°ë¡œ ìˆ˜í–‰í•˜ë‹¤ë³´ë‹ˆ ì›¹í˜ì´ì§€ ë¬¸ìì—´ì´ ìš°ë¦¬ê°€ ì›í•˜ëŠ” ìˆœì„œëŒ€ë¡œ ë‹´ê²¨ì ¸ <code class="highlighter-rouge">merge_text()</code>ë¡œ ì „ë‹¬ëœë‹¤ëŠ” ë³´ì¥ì´ ì—†ìŠµë‹ˆë‹¤. ì‘ì—…ì´ ë¨¼ì € ëë‚˜ëŠ” ìˆœì„œëŒ€ë¡œ ê²°ê³¼ê°€ ë‹´ê¸°ë‹ˆ 0 - 1 - 2 - 3 â€¦ ìˆœì„œê°€ ë  ì§€ 9 - 4 - 7 - 1 ìˆœì„œê°€ ë  ì§€ëŠ” ì•„ë¬´ë„ ëª¨ë¦…ë‹ˆë‹¤.</p>

<p>ì—¬ëŸ¬ í•´ê²°ì±…ì´ ìˆê² ì§€ë§Œ, ê° ì‘ì—…ìë§ˆë‹¤ ìˆœë²ˆì„ ì£¼ê³ , <code class="highlighter-rouge">merge_text()</code>ëŠ” ì´ ìˆœë²ˆëŒ€ë¡œ ë¬¸ìì—´ì„ í•©ì¹˜ë©´ ë˜ê² ë„¤ìš”.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@app.task
def fetch_page_by_url(url, num):
    res = requests.get(url)

    if int(res.status_code / 100) == 2:
        return res.text, num

@app.task
def merge_text(texts):
    assert(isinstance(texts, MutableSequence))
    texts.sort(key=lambda x: x[1])
    return texts.join('')

tasks = []
for i in range(0, 10):
    tasks.append(
        fetch_page_by_url.s(
            'http://localhost:8000/{}.html'.format(i), i
        )
    )
</code></pre></div></div>

<p>ê° <code class="highlighter-rouge">fetch_page_by_url()</code>ì— ë‘ ë²ˆì§¸ ì¸ìë¡œ ìˆœë²ˆ(<code class="highlighter-rouge">i</code>)ì„ ì „ë‹¬í•˜ê³ , <code class="highlighter-rouge">fetch_page_by_url()</code>ëŠ” ë°›ì€ ìˆœë²ˆì„ ì›¹í˜ì´ì§€ ë¬¸ìì—´ê³¼ í•¨ê»˜ ê·¸ëŒ€ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤. <code class="highlighter-rouge">merge_text()</code>ê°€ ì „ë‹¬ë°›ì€ <code class="highlighter-rouge">texts</code>ì—” ê° <code class="highlighter-rouge">fetch_page_by_url()</code> ê²°ê³¼ê°€ <code class="highlighter-rouge">[(ë¬¸ìì—´, 0), (ë¬¸ìì—´, 3), ...]</code> í˜•íƒœë¡œ ë‹´ê¹ë‹ˆë‹¤. ê·¸ë˜ì„œ ê° í•­ëª©ì˜ ë‘ ë²ˆì§¸(<code class="highlighter-rouge">[1]</code>) ê°’ìœ¼ë¡œ ì •ë ¬í•˜ê³  ë‚˜ì„œ í•œ ë¬¸ìì—´ë¡œ í•©ì¹œ ê²ƒì…ë‹ˆë‹¤.</p>

<ul>
  <li><a href="http://celery.readthedocs.org/en/latest/userguide/canvas.html#the-primitives">Canvas: Designing Workflows : The primitives</a></li>
  <li><a href="http://celery.readthedocs.org/en/latest/userguide/tasks.html#avoid-launching-synchronous-subtasks">Tasks : Avoid launching synchronous subtasks</a></li>
</ul>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>ëŒ€ê°œëŠ” <code class="highlighter-rouge">delay()</code>ë¼ëŠ” ë©”ì„œë“œë¡œ ì¤„ì—¬ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.Â <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>ëŒ€ê°œëŠ” <code class="highlighter-rouge">s()</code>ë¡œ ì¤„ì¸ ë©”ì„œë“œ ì´ë¦„ì„ ì”ë‹ˆë‹¤.Â <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p><code class="highlighter-rouge">chain</code>ê³¼ <code class="highlighter-rouge">chord</code>ëŠ” í•¨ìˆ˜ì²˜ëŸ¼ ìƒê²¼ì§€ë§Œ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.Â <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>
:ET